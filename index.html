<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #f8f9fa;
            --accent: #ff4d6d;
            --glass: rgba(255, 255, 255, 0.1);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: var(--font-main);
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        /* Loading Screen */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            transition: opacity 1s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Birthday Overlay */
        #birthday-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            text-align: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--glass);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 400px;
        }

        h1 { color: var(--accent); font-size: 2.5rem; margin-bottom: 10px; }
        p { color: white; margin-bottom: 25px; line-height: 1.6; }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        button:active { transform: scale(0.95); }

        /* UI Controls */
        #joystick-container {
            position: fixed;
            bottom: 40px;
            left: 40px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: none;
            touch-action: none;
        }

        #joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px;">Setting up the gallery...</p>
    </div>

    <div id="birthday-modal">
        <div class="modal-content">
            <h1>Happy Birthday!</h1>
            <p>I built this virtual gallery to celebrate your special day. Wander through the memories we've shared.</p>
            <button id="start-btn">Enter Gallery</button>
        </div>
    </div>

    <div id="joystick-container">
        <div id="joystick-knob"></div>
    </div>

    <div class="instructions">Drag left side to move â€¢ Drag right side to look</div>

    <audio id="bg-music" loop>
        <source src="https://www.chosic.com/wp-content/uploads/2021/04/Lofi-Study-Music.mp3" type="audio/mpeg">
    </audio>

    <div id="canvas-container"></div>

    <script>
        /**
         * CONFIGURATION
         */
        const CONFIG = {
            csvUrl: 'PASTE_YOUR_GOOGLE_SHEET_CSV_URL_HERE', 
            moveSpeed: 0.12,
            lookSensitivity: 0.003,
            roomSize: 20,         // Width of each room
            roomLength: 30,       // Length of each room
            numRooms: 3,          // How many rooms to generate
            paintingSize: 3.5,
            proximityDistance: 6
        };

        // Fallback images (scaled up for testing multi-room)
        const FALLBACK_IMAGES = Array.from({length: 45}, (_, i) => `https://picsum.photos/id/${10 + i}/800/800`);

        let scene, camera, renderer, clock;
        let paintings = [];
        let moveState = { forward: 0, right: 0 };
        let lookState = { lat: 0, lon: 0 };
        let joystickActive = false;
        let touchStartPos = new THREE.Vector2();

        async function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.FogExp2(0x050505, 0.03);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 10); 

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);

            // Add lights for each room
            for(let i = 0; i < CONFIG.numRooms; i++) {
                const light = new THREE.PointLight(0xffffff, 0.7, 40);
                light.position.set(0, 6, -i * CONFIG.roomLength - (CONFIG.roomLength / 2));
                scene.add(light);
            }

            createGalleryArchitecture();

            const imageUrls = await fetchImageUrls();
            setupPaintings(imageUrls);

            window.addEventListener('resize', onWindowResize);
            setupControls();

            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('birthday-modal').style.display = 'flex';
            }, 1000);

            animate();
        }

        async function fetchImageUrls() {
            try {
                if (CONFIG.csvUrl.includes('PASTE_YOUR')) throw new Error('Default');
                const response = await fetch(CONFIG.csvUrl);
                const data = await response.text();
                return data.split('\n').map(row => row.trim()).filter(url => url.startsWith('http'));
            } catch (e) {
                return FALLBACK_IMAGES;
            }
        }

        function createGalleryArchitecture() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x151515, roughness: 0.8 });
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x080808, roughness: 0.2, metalness: 0.4 });
            
            const totalLength = CONFIG.numRooms * CONFIG.roomLength;

            // Floor
            const floorGeo = new THREE.PlaneGeometry(CONFIG.roomSize, totalLength);
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.z = -totalLength / 2 + 15; // Offset to start at 0
            scene.add(floor);

            // Ceiling
            const ceil = new THREE.Mesh(floorGeo, wallMat);
            ceil.rotation.x = Math.PI / 2;
            ceil.position.y = 8;
            ceil.position.z = floor.position.z;
            scene.add(ceil);

            for (let i = 0; i < CONFIG.numRooms; i++) {
                const zCenter = -i * CONFIG.roomLength;
                
                // Side Walls
                const sideWallGeo = new THREE.PlaneGeometry(CONFIG.roomLength, 8);
                
                const leftWall = new THREE.Mesh(sideWallGeo, wallMat);
                leftWall.rotation.y = Math.PI / 2;
                leftWall.position.set(-CONFIG.roomSize/2, 4, zCenter - CONFIG.roomLength/2);
                scene.add(leftWall);

                const rightWall = new THREE.Mesh(sideWallGeo, wallMat);
                rightWall.rotation.y = -Math.PI / 2;
                rightWall.position.set(CONFIG.roomSize/2, 4, zCenter - CONFIG.roomLength/2);
                scene.add(rightWall);

                // Dividers/Archways (except at very end)
                if (i < CONFIG.numRooms) {
                    const dividerGeo = new THREE.PlaneGeometry((CONFIG.roomSize - 6) / 2, 8);
                    
                    // Left divider
                    const ld = new THREE.Mesh(dividerGeo, wallMat);
                    ld.position.set(-CONFIG.roomSize/2 + (CONFIG.roomSize - 6)/4, 4, zCenter - CONFIG.roomLength);
                    scene.add(ld);

                    // Right divider
                    const rd = new THREE.Mesh(dividerGeo, wallMat);
                    rd.position.set(CONFIG.roomSize/2 - (CONFIG.roomSize - 6)/4, 4, zCenter - CONFIG.roomLength);
                    scene.add(rd);

                    // Top lintel
                    const lintel = new THREE.Mesh(new THREE.PlaneGeometry(6, 2.5), wallMat);
                    lintel.position.set(0, 6.75, zCenter - CONFIG.roomLength);
                    scene.add(lintel);
                }
            }
        }

        function setupPaintings(urls) {
            const loader = new THREE.TextureLoader();
            const imgsPerRoom = 15;
            
            urls.forEach((url, index) => {
                const roomIdx = Math.floor(index / imgsPerRoom);
                if (roomIdx >= CONFIG.numRooms) return;

                const localIdx = index % imgsPerRoom;
                const zBase = -roomIdx * CONFIG.roomLength;
                
                let x, z, rot;

                if (localIdx < 6) { 
                    // 6 on Left Wall
                    x = -CONFIG.roomSize / 2 + 0.1;
                    z = zBase - ((localIdx + 1) * (CONFIG.roomLength / 7));
                    rot = Math.PI / 2;
                } else if (localIdx < 12) { 
                    // 6 on Right Wall
                    x = CONFIG.roomSize / 2 - 0.1;
                    z = zBase - ((localIdx - 5) * (CONFIG.roomLength / 7));
                    rot = -Math.PI / 2;
                } else { 
                    // 3 on Divider/End Wall
                    const posInRow = localIdx - 12;
                    x = -5 + (posInRow * 5);
                    z = zBase - CONFIG.roomLength + 0.1;
                    rot = 0;
                    // Don't place in the middle of an archway
                    if (roomIdx < CONFIG.numRooms - 1 && posInRow === 1) return;
                }

                loader.load(url, (texture) => {
                    const aspect = texture.image.width / texture.image.height;
                    const h = CONFIG.paintingSize;
                    const w = h * aspect;

                    const frame = new THREE.Mesh(
                        new THREE.BoxGeometry(w + 0.2, h + 0.2, 0.1),
                        new THREE.MeshStandardMaterial({ color: 0x000000 })
                    );

                    const canvas = new THREE.Mesh(
                        new THREE.PlaneGeometry(w, h),
                        new THREE.MeshBasicMaterial({ map: texture })
                    );
                    canvas.position.z = 0.06;
                    frame.add(canvas);

                    frame.position.set(x, 3, z);
                    frame.rotation.y = rot;
                    frame.userData = { targetScale: 1 };
                    
                    scene.add(frame);
                    paintings.push(frame);
                });
            });
        }

        function setupControls() {
            const startBtn = document.getElementById('start-btn');
            const joyContainer = document.getElementById('joystick-container');
            const joyKnob = document.getElementById('joystick-knob');
            const music = document.getElementById('bg-music');

            startBtn.addEventListener('click', () => {
                document.getElementById('birthday-modal').style.display = 'none';
                joyContainer.style.display = 'block';
                music.play();
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            });

            window.addEventListener('touchstart', (e) => {
                if (e.touches[0].clientX < window.innerWidth / 2) {
                    joystickActive = true;
                    touchStartPos.set(e.touches[0].clientX, e.touches[0].clientY);
                }
            });

            window.addEventListener('touchmove', (e) => {
                if (joystickActive) {
                    const dx = e.touches[0].clientX - touchStartPos.x;
                    const dy = e.touches[0].clientY - touchStartPos.y;
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                    const angle = Math.atan2(dy, dx);
                    joyKnob.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
                    moveState.forward = -Math.sin(angle) * (dist / 40);
                    moveState.right = Math.cos(angle) * (dist / 40);
                } else if (e.touches[0].clientX > window.innerWidth / 2) {
                    lookState.lon += (e.movementX || 0) * 0.5;
                    lookState.lat -= (e.movementY || 0) * 0.5;
                }
            });

            window.addEventListener('touchend', () => {
                joystickActive = false;
                moveState.forward = 0; moveState.right = 0;
                joyKnob.style.transform = `translate(-50%, -50%)`;
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'w' || e.key === 'ArrowUp') moveState.forward = 1;
                if (e.key === 's' || e.key === 'ArrowDown') moveState.forward = -1;
                if (e.key === 'a' || e.key === 'ArrowLeft') moveState.right = -1;
                if (e.key === 'd' || e.key === 'ArrowRight') moveState.right = 1;
            });
            window.addEventListener('keyup', (e) => {
                if (['w','s','ArrowUp','ArrowDown'].includes(e.key)) moveState.forward = 0;
                if (['a','d','ArrowLeft','ArrowRight'].includes(e.key)) moveState.right = 0;
            });

            window.addEventListener('mousemove', (e) => {
                if (document.getElementById('birthday-modal').style.display === 'none' && e.buttons === 1) {
                    lookState.lon += e.movementX * 0.1;
                    lookState.lat -= e.movementY * 0.1;
                }
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            lookState.lat = Math.max(-85, Math.min(85, lookState.lat));
            const phi = THREE.MathUtils.degToRad(90 - lookState.lat);
            const theta = THREE.MathUtils.degToRad(lookState.lon);

            const target = new THREE.Vector3();
            target.setFromSphericalCoords(1, phi, theta).add(camera.position);
            camera.lookAt(target);

            if (moveState.forward !== 0 || moveState.right !== 0) {
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                direction.y = 0; direction.normalize();
                const side = new THREE.Vector3().crossVectors(direction, camera.up).negate();

                camera.position.addScaledVector(direction, moveState.forward * CONFIG.moveSpeed);
                camera.position.addScaledVector(side, moveState.right * CONFIG.moveSpeed);
                
                // Boundaries
                const xLimit = (CONFIG.roomSize / 2) - 1.2;
                const zLimitMin = 14; 
                const zLimitMax = -(CONFIG.numRooms * CONFIG.roomLength) + 1.2;
                camera.position.x = Math.max(-xLimit, Math.min(xLimit, camera.position.x));
                camera.position.z = Math.max(zLimitMax, Math.min(zLimitMin, camera.position.z));
            }

            paintings.forEach(p => {
                const dist = camera.position.distanceTo(p.position);
                p.userData.targetScale = dist < CONFIG.proximityDistance ? 1.4 : 1.0;
                p.scale.lerp(new THREE.Vector3().setScalar(p.userData.targetScale), 0.1);
            });

            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>