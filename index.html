<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #f8f9fa;
            --accent: #ff4d6d;
            --glass: rgba(255, 255, 255, 0.1);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: var(--font-main); touch-action: none;
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            color: white; transition: opacity 1s ease;
        }

        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--glass);
            border-top: 3px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        #birthday-modal, #controls-tutorial {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 999; text-align: center; padding: 20px;
        }

        .modal-content, .tutorial-content {
            background: var(--glass); padding: 40px; border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.2); max-width: 400px;
        }

        h1 { color: var(--accent); font-size: 2.5rem; margin-bottom: 10px; }
        p { color: white; margin-bottom: 25px; line-height: 1.6; }

        button {
            background: var(--accent); color: white; border: none;
            padding: 15px 35px; font-size: 1.1rem; border-radius: 30px;
            cursor: pointer; font-weight: 600;
        }

        .control-item {
            display: flex; align-items: center; margin: 15px 0;
            padding: 10px; background: rgba(255,255,255,0.05);
            border-radius: 12px; text-align: left;
        }

        #joystick-container {
            position: fixed; bottom: 40px; left: 40px; width: 100px; height: 100px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%; display: none; z-index: 100;
        }

        #joystick-knob {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            background: var(--accent); border-radius: 50%; transform: translate(-50%, -50%);
        }

        #look-touch-area {
            position: fixed; top: 0; right: 0; width: 60%; height: 100%;
            display: none; z-index: 99;
        }

        .instructions {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            color: white; font-size: 0.8rem; pointer-events: none; z-index: 101;
            background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p>Opening Gallery...</p></div>

    <div id="birthday-modal">
        <div class="modal-content">
            <h1>Happy Birthday! üéâ</h1>
            <p>Welcome to your personal art gallery filled with special memories.</p>
            <button id="start-btn">Enter Gallery</button>
        </div>
    </div>

    <div id="controls-tutorial">
        <div class="tutorial-content">
            <h2 style="color: var(--accent);">Controls</h2>
            <div class="control-item"><span>üéÆ Left: Walk</span></div>
            <div class="control-item"><span>üëÄ Right: Look Around</span></div>
            <div class="control-item"><span>üîç Tap Art: Zoom In</span></div>
            <button id="tutorial-continue" style="width:100%">Let's Go!</button>
        </div>
    </div>

    <div id="joystick-container"><div id="joystick-knob"></div></div>
    <div id="look-touch-area"></div>
    <div class="instructions">Joystick to Move ‚Ä¢ Drag Right to Look ‚Ä¢ Tap Art to Zoom</div>
    <audio id="bg-music" loop><source src="https://www.chosic.com/wp-content/uploads/2021/04/Lofi-Study-Music.mp3" type="audio/mpeg"></audio>
    <div id="canvas-container"></div>

    <script>
        const CONFIG = {
            csvUrl: 'PASTE_YOUR_GOOGLE_SHEET_CSV_URL_HERE', 
            moveSpeed: 0.22,
            lookSensitivity: 0.2, // Smoother look
            roomSize: 20,
            roomLength: 30,
            numRooms: 3,
            wallHeight: 8
        };

        const FALLBACK_IMAGES = Array.from({length: 30}, (_, i) => `https://picsum.photos/id/${10 + i}/800/800`);

        let scene, camera, renderer, clock;
        let paintings = [];
        let moveState = { forward: 0, right: 0 };
        let lookState = { lat: 0, lon: 180 }; // FACE GALLERY AT START (180 deg)
        let joystickActive = false, isLooking = false;
        let lastTouchX = 0, lastTouchY = 0, focusedPainting = null;

        async function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 8); // Start at entrance

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(1); // Performance for low-end
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            createGalleryArchitecture();
            const urls = await fetchImageUrls();
            setupPaintings(urls);
            setupControls();

            document.getElementById('loader').style.display = 'none';
            document.getElementById('birthday-modal').style.display = 'flex';
            animate();
        }

        async function fetchImageUrls() {
            try {
                if (CONFIG.csvUrl.includes('PASTE')) throw new Error();
                const r = await fetch(CONFIG.csvUrl);
                const d = await r.text();
                return d.split('\n').map(l => l.trim()).filter(u => u.startsWith('http'));
            } catch { return FALLBACK_IMAGES; }
        }

        function createGalleryArchitecture() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
            const len = CONFIG.numRooms * CONFIG.roomLength;
            const w = CONFIG.roomSize;
            const h = CONFIG.wallHeight;

            // Solid Floor
            const floor = new THREE.Mesh(new THREE.BoxGeometry(w+2, 0.2, len+20), new THREE.MeshStandardMaterial({color:0x111111}));
            floor.position.set(0, -0.1, -len/2 + 5);
            scene.add(floor);

            // Left Wall
            const leftW = new THREE.Mesh(new THREE.BoxGeometry(0.5, h, len+20), wallMat);
            leftW.position.set(-w/2, h/2, -len/2 + 5);
            scene.add(leftW);

            // Right Wall
            const rightW = new THREE.Mesh(new THREE.BoxGeometry(0.5, h, len+20), wallMat);
            rightW.position.set(w/2, h/2, -len/2 + 5);
            scene.add(rightW);

            // Back Wall
            const backW = new THREE.Mesh(new THREE.BoxGeometry(w, h, 0.5), wallMat);
            backW.position.set(0, h/2, -len);
            scene.add(backW);

            // Front Wall
            const frontW = new THREE.Mesh(new THREE.BoxGeometry(w, h, 0.5), wallMat);
            frontW.position.set(0, h/2, 10);
            scene.add(frontW);
        }

        function setupPaintings(urls) {
            const loader = new THREE.TextureLoader();
            urls.forEach((url, i) => {
                loader.load(url, (tex) => {
                    const aspect = tex.image.width / tex.image.height;
                    const h = 3.5, w = h * aspect;
                    const frame = new THREE.Mesh(new THREE.BoxGeometry(w+0.2, h+0.2, 0.1), new THREE.MeshStandardMaterial({color:0x222222}));
                    const art = new THREE.Mesh(new THREE.PlaneGeometry(w, h), new THREE.MeshBasicMaterial({map:tex}));
                    art.position.z = 0.06;
                    frame.add(art);

                    // Distribute along walls
                    const side = i % 2 === 0 ? 1 : -1;
                    frame.position.set((CONFIG.roomSize/2 - 0.3) * side, 3.5, - (i * 4) - 5);
                    frame.rotation.y = (Math.PI/2) * -side;
                    
                    scene.add(frame);
                    paintings.push(frame);
                });
            });
        }

        function setupControls() {
            const joy = document.getElementById('joystick-container');
            const knob = document.getElementById('joystick-knob');
            
            document.getElementById('start-btn').onclick = () => {
                document.getElementById('birthday-modal').style.display = 'none';
                document.getElementById('controls-tutorial').style.display = 'flex';
            };

            document.getElementById('tutorial-continue').onclick = () => {
                document.getElementById('controls-tutorial').style.display = 'none';
                joy.style.display = 'block';
                document.getElementById('look-touch-area').style.display = 'block';
                document.getElementById('bg-music').play();
                confetti({ particleCount: 100 });
            };

            // Non-Inverted Touch Look
            document.getElementById('look-touch-area').ontouchstart = (e) => {
                isLooking = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            };

            document.getElementById('look-touch-area').ontouchmove = (e) => {
                if(!isLooking) return;
                let dx = e.touches[0].clientX - lastTouchX;
                let dy = e.touches[0].clientY - lastTouchY;
                lookState.lon += dx * CONFIG.lookSensitivity; // Right = Right
                lookState.lat -= dy * CONFIG.lookSensitivity; // Up = Up
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            };

            // Mouse Look
            window.onmousemove = (e) => { if(e.buttons === 1) { 
                lookState.lon += e.movementX * 0.1; 
                lookState.lat -= e.movementY * 0.1; 
            }};

            // Joystick
            joy.ontouchmove = (e) => {
                joystickActive = true;
                const rect = joy.getBoundingClientRect();
                const dx = e.touches[0].clientX - (rect.left + 50);
                const dy = e.touches[0].clientY - (rect.top + 50);
                const angle = Math.atan2(dy, dx);
                const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                knob.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
                moveState.forward = -Math.sin(angle) * (dist/40);
                moveState.right = Math.cos(angle) * (dist/40);
            };
            joy.ontouchend = () => { moveState.forward = 0; moveState.right = 0; knob.style.transform='translate(-50%, -50%)'; joystickActive=false; };

            // Tap to Zoom
            window.onclick = (e) => {
                if(joystickActive) return;
                const mouse = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
                const ray = new THREE.Raycaster();
                ray.setFromCamera(mouse, camera);
                const hits = ray.intersectObjects(paintings, true);
                if(hits.length > 0) {
                    let p = hits[0].object;
                    while(p.parent && !paintings.includes(p)) p = p.parent;
                    focusedPainting = p;
                } else { focusedPainting = null; }
            };
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update Look
            lookState.lat = Math.max(-85, Math.min(85, lookState.lat));
            const phi = THREE.MathUtils.degToRad(90 - lookState.lat);
            const theta = THREE.MathUtils.degToRad(lookState.lon);
            const target = new THREE.Vector3().setFromSphericalCoords(1, phi, theta).add(camera.position);
            camera.lookAt(target);

            if (focusedPainting) {
                const viewPos = new THREE.Vector3(0, 0, 4).applyQuaternion(focusedPainting.quaternion).add(focusedPainting.position);
                viewPos.y = 1.7;
                camera.position.lerp(viewPos, 0.05);
                if(Math.abs(moveState.forward) > 0.1) focusedPainting = null;
            } else if (Math.abs(moveState.forward) > 0 || Math.abs(moveState.right) > 0) {
                const dir = new THREE.Vector3();
                camera.getWorldDirection(dir);
                dir.y = 0; dir.normalize();
                const side = new THREE.Vector3().crossVectors(camera.up, dir);

                camera.position.addScaledVector(dir, moveState.forward * CONFIG.moveSpeed);
                camera.position.addScaledVector(side, -moveState.right * CONFIG.moveSpeed);

                // SOLID WALL COLLISIONS
                const border = 1.5;
                camera.position.x = Math.max(-CONFIG.roomSize/2 + border, Math.min(CONFIG.roomSize/2 - border, camera.position.x));
                camera.position.z = Math.max(-(CONFIG.numRooms * CONFIG.roomLength) + border, Math.min(9, camera.position.z));
                camera.position.y = 1.7;
            }

            renderer.render(scene, camera);
        }

        window.onload = init;
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>