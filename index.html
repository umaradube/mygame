<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f8f9fa; --accent: #ff4d6d; --glass: rgba(255, 255, 255, 0.1); --font-main: 'Segoe UI', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: var(--font-main); touch-action: none; }
        #canvas-container { width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--glass); border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #birthday-modal, #controls-tutorial { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; text-align: center; padding: 20px; }
        .modal-content, .tutorial-content { background: var(--glass); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); max-width: 400px; color: white; }
        button { background: var(--accent); color: white; border: none; padding: 12px 30px; font-size: 1rem; border-radius: 30px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        #joystick-container { position: fixed; bottom: 30px; left: 30px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; z-index: 100; touch-action: none; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 35px; height: 35px; background: var(--accent); border-radius: 50%; transform: translate(-50%, -50%); }
        #look-touch-area { position: fixed; top: 0; right: 0; width: 60%; height: 100%; display: none; z-index: 99; }
        #perf-monitor { position: fixed; top: 10px; right: 10px; color: #0f0; font-size: 10px; font-family: monospace; z-index: 1000; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p>Optimizing for your device...</p></div>
    <div id="perf-monitor">FPS: --</div>

    <div id="birthday-modal">
        <div class="modal-content">
            <h1>Happy Birthday! ðŸŽ‰</h1>
            <p>Welcome to your personal 3D gallery.</p>
            <button id="start-btn">Enter Gallery</button>
        </div>
    </div>

    <div id="controls-tutorial">
        <div class="tutorial-content">
            <h2>Controls</h2>
            <p>Left side: Move | Right side: Look</p>
            <button id="tutorial-continue">Let's Go!</button>
        </div>
    </div>

    <div id="joystick-container"><div id="joystick-knob"></div></div>
    <div id="look-touch-area"></div>

    <audio id="bg-music" loop><source src="https://www.chosic.com/wp-content/uploads/2021/04/Lofi-Study-Music.mp3" type="audio/mpeg"></audio>
    <div id="canvas-container"></div>

    <script>
        const CONFIG = {
            moveSpeed: 0.15,
            lookSensitivity: 0.002,
            roomLength: 30,
            roomSize: 20,
            numRooms: 3,
            paintingSize: 3.5
        };

        let scene, camera, renderer, clock, paintings = [];
        let moveState = { forward: 0, right: 0 }, lookState = { lat: 0, lon: 0 };
        let joystickActive = false, isLooking = false, lastTouchX = 0, lastTouchY = 0;

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.Fog(0x050505, 1, 60);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 5);

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1 : 1); // Low-end optimization
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Lights - Minimal for performance
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.4);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            createSimpleGallery();
            setupControls();
            
            // Start sequence
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('birthday-modal').style.display = 'flex';
            }, 500);

            animate();
        }

        function createSimpleGallery() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            
            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 200), floorMat);
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // Basic Walls
            for(let i=0; i<CONFIG.numRooms; i++) {
                const zPos = -i * CONFIG.roomLength;
                const wallLeft = new THREE.Mesh(new THREE.PlaneGeometry(CONFIG.roomLength, 8), wallMat);
                wallLeft.position.set(-CONFIG.roomSize/2, 4, zPos - CONFIG.roomLength/2);
                wallLeft.rotation.y = Math.PI/2;
                scene.add(wallLeft);

                const wallRight = wallLeft.clone();
                wallRight.position.x = CONFIG.roomSize/2;
                wallRight.rotation.y = -Math.PI/2;
                scene.add(wallRight);
                
                // Add sample paintings
                addPainting(zPos - 10, -9.9, Math.PI/2);
                addPainting(zPos - 20, 9.9, -Math.PI/2);
            }
        }

        function addPainting(z, x, rot) {
            const frame = new THREE.Mesh(
                new THREE.BoxGeometry(CONFIG.paintingSize, CONFIG.paintingSize, 0.1),
                new THREE.MeshStandardMaterial({color: 0x111111})
            );
            frame.position.set(x, 4, z);
            frame.rotation.y = rot;
            scene.add(frame);
            paintings.push(frame);
        }

        function setupControls() {
            const joyContainer = document.getElementById('joystick-container');
            const joyKnob = document.getElementById('joystick-knob');

            document.getElementById('start-btn').onclick = () => {
                document.getElementById('birthday-modal').style.display = 'none';
                document.getElementById('controls-tutorial').style.display = 'flex';
            };

            document.getElementById('tutorial-continue').onclick = () => {
                document.getElementById('controls-tutorial').style.display = 'none';
                joyContainer.style.display = 'block';
                document.getElementById('look-touch-area').style.display = 'block';
                document.getElementById('bg-music').play();
            };

            // FIXED JOYSTICK (Non-inverted)
            joyContainer.addEventListener('touchstart', (e) => { joystickActive = true; });
            joyContainer.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                const rect = joyContainer.getBoundingClientRect();
                const touch = e.touches[0];
                const dx = touch.clientX - (rect.left + rect.width/2);
                const dy = touch.clientY - (rect.top + rect.height/2);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 30);
                const angle = Math.atan2(dy, dx);
                
                const moveX = Math.cos(angle) * dist;
                const moveY = Math.sin(angle) * dist;
                
                joyKnob.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
                
                moveState.forward = -moveY / 30; // Negative dy = move forward
                moveState.right = moveX / 30;
            });

            joyContainer.addEventListener('touchend', () => {
                joystickActive = false;
                moveState.forward = 0; moveState.right = 0;
                joyKnob.style.transform = `translate(-50%, -50%)`;
            });

            // Look Controls
            const lookArea = document.getElementById('look-touch-area');
            lookArea.addEventListener('touchstart', (e) => {
                isLooking = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            });
            lookArea.addEventListener('touchmove', (e) => {
                if(!isLooking) return;
                const touch = e.touches[0];
                lookState.lon += (touch.clientX - lastTouchX) * 0.3;
                lookState.lat -= (touch.clientY - lastTouchY) * 0.3;
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
            });
            lookArea.addEventListener('touchend', () => isLooking = false);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Update Rotation
            lookState.lat = Math.max(-85, Math.min(85, lookState.lat));
            const phi = THREE.MathUtils.degToRad(90 - lookState.lat);
            const theta = THREE.MathUtils.degToRad(lookState.lon);

            const target = new THREE.Vector3();
            target.setFromSphericalCoords(1, phi, theta).add(camera.position);
            camera.lookAt(target);

            // Update Movement
            if (moveState.forward !== 0 || moveState.right !== 0) {
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                direction.y = 0; direction.normalize();

                const side = new THREE.Vector3().crossVectors(camera.up, direction).normalize();
                
                camera.position.addScaledVector(direction, moveState.forward * CONFIG.moveSpeed);
                camera.position.addScaledVector(side, -moveState.right * CONFIG.moveSpeed);
            }

            // Proximity animation (Pulse paintings near user)
            paintings.forEach(p => {
                const dist = p.position.distanceTo(camera.position);
                if(dist < 5) p.scale.set(1.1, 1.1, 1.1);
                else p.scale.set(1, 1, 1);
            });

            renderer.render(scene, camera);
            
            // Simple FPS monitor
            document.getElementById('perf-monitor').innerText = `FPS: ${Math.round(1/delta)}`;
        }

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>